# PRD: 시계열 기반 구독 해지 시기 예측 & 선제 쿠폰/프로모션 자동화

------------------------------------------------------------------------

## 0. 목표 & KPI

-   해지율 (상대 10%) 감소
-   고위험군 프로모션 전환율 (+3pp) 상승
-   발송량 30% 절감

**모델 KPI**

-   ROC-AUC ≥ 0.78
-   PR-AUC ≥ baseline + 30%
-   Precision@TopK ≥ 0.35

------------------------------------------------------------------------

## 1. 범위

**포함(In)** - 해지 위험 점수 예측 (배치/실시간) - 결제/구독 상태/상품
변경 데이터 기반 피처 - 프로모션 추천 로직 - LLM+RAG 메시지 생성 - 모델
학습/파인튜닝/경량화 파이프라인 - Angular UI 연동, 관리자 대시보드

**제외(Out)** - 결제 게이트웨이 수정 - 외부 제휴 계약 - 사용자 로그인
이벤트 기반 피처 (별도 수집 불가)

------------------------------------------------------------------------

## 2. 시스템 아키텍처

``` mermaid
flowchart LR
  D[(Postgres<br/>구독/결제DB)] --> E[ETL & Feature Jobs]
  E --> F[(Feature Store<br/>PG MV + S3/Parquet)]

  L[(Web/App Logs<br/>GA→BigQuery)] --> K[(ETL)]
  K --> F

  F --> T[Trainer<br/>Python+Optuna]
  T --> R[(Model Registry<br/>S3+버전 관리)]
  R --> S[ai-service<br/>ONNXRuntime on ECS]

  S -->|Cache| C[(Redis)]
  S -->|Lookup| F
  S -->|Score API| P[Promotion Engine]
```

-   Redis: 실시간 API 추론용 캐시
-   Postgres MV: 일배치 점수/분석용
-   Google Analytics → BigQuery → Feature Store: 행동로그 연계

------------------------------------------------------------------------

## 3. 데이터 모델 & 스키마

-   **ai_user_metrics**: 사용자별 최신 점수 저장
-   **ai_scored_event**: 예측 이벤트 및 근거 기록
-   **ai_action_log**: 쿠폰 발급 등 액션 로그 기록

------------------------------------------------------------------------

## 4. 데이터 파이프라인

-   **라벨링**
    -   해지일(`SBSC_END_DT`) N일 전 데이터: `label=1`\
    -   그 외: `label=0`
-   **피처**
    -   결제 (TBIL_SBSC_PMT_HIST_L)
    -   구독 상태 (TBIL_SBSC_STAT_L)
    -   상품 변경 (TBIL_SBSC_PROD_SWTCH_L)
    -   행동로그 (GA 기반)
        -   `cancel_keyword_search_cnt_14d`\
        -   `faq_cancel_views_14d`\
        -   `cancel_page_visit_14d`\
        -   `session_duration_mean_14d`
-   **저장소**
    -   학습: S3/Parquet\
    -   서빙: Redis 캐시 / Postgres MV

------------------------------------------------------------------------

## 5. 모델 설계 및 운영

-   앙상블 구조: GBDT + LSTM
-   월 단위 파인튜닝 (Optuna 기반)
-   ONNX 변환 + INT8 양자화
-   ECS Fargate 서빙

------------------------------------------------------------------------

## 6. API 설계

-   `POST /api/v1/churn/score` → 사용자별 위험 점수
-   `POST /api/v1/promotion/recommend` → 프로모션 추천
-   `POST /api/v1/message/generate` → RAG 기반 메시지 생성

------------------------------------------------------------------------

## 7. 프로모션 엔진

-   risk_level=high + cancel_page_visit → 쿠폰 발급
-   월 1회 제한, 대시보드에서 룰 수정 가능

------------------------------------------------------------------------

## 8. LLM+RAG

-   코퍼스: FAQ, 약관, 쿠폰 조건
-   Embedding: e5-base / Ko-SBERT
-   Vector index: pgvector
-   LLM: 7B 한국어 모델 LoRA 파인튜닝
-   Guardrails: 길이 제한, 금지어 필터

------------------------------------------------------------------------



------------------------------------------------------------------------

## 10. 보안 및 운영

-   PII 암호화, RBAC
-   감사로그(ai_action_log)
-   SLO: p95 \< 200ms

------------------------------------------------------------------------

## 11. 테스트 계획

-   단위: API 응답 정확성
-   통합: ETL → 모델 → API → 프로모션 흐름
-   성능: 200 RPS 이상 처리

------------------------------------------------------------------------

## 12. 향후 계획 / 연구 보완

-   **사용자 행동로그 확장 활용**
    -   현재 Google Analytics(GA) 기반으로 **검색·FAQ 조회·해지페이지
        방문·세션시간** 데이터를 수집 가능\
    -   GA → BigQuery Export → ETL → Feature Store → 모델 학습에 반영
        예정\
    -   로그인 빈도는 GA 기본 이벤트로는 확보 불가하므로 이번 과제
        범위에서는 제외\
-   **예상 효과**
    -   행동 데이터 반영 시 해지 의도 탐지 정밀도 향상 (특히 PR-AUC 개선
        기대)
    -   추후 실험적으로 "행동로그만 활용한 서브모델"도 연구하여 주
        모델과 비교 가능

------------------------------------------------------------------------
